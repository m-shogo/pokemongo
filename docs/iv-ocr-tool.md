# Pokémon GO IV 自動入力ツール 手順書

## 1. 概要（まず最初に確認してください）
- 目的: iPhone 上の Pokémon GO 画面を Windows PC にミラー表示し、9db の IV 計算ページ (https://9db.jp/pokemongo/data/6606) に自動入力します。
- スワイプ操作は手動です。自動入力のみをスクリプトで支援します。
- 入力ソースは 2 パターンを選択できます。
  - Screen/Window 共有: AirPlay ミラーアプリのウィンドウを `getDisplayMedia` で取得
  - Camera/キャプチャカード: Lightning→HDMI→USB キャプチャを `getUserMedia` で直接取得
- ブラウザ拡張 Tampermonkey 上のユーザースクリプトが、映像から `Tesseract.js` を用いて CP/HP/ほしのすな を OCR し、9db 側の DOM に自動入力します。
- DOM への入力は、ラベル (CP/HP/ほしのすな) や `name`/`id`/`placeholder` を組み合わせた検出で耐性を持たせています。

## 2. 事前準備（Windows + iOS）
1. **ブラウザ準備**
   - Windows に最新の Google Chrome または Microsoft Edge をインストールしてください。
   - ブラウザは常に最新版に更新しておくと、キャプチャ API の権限まわりで失敗しにくくなります。
2. **Tampermonkey の導入**
   - ブラウザ拡張ストアから Tampermonkey をインストールし、有効化します。
3. **9db IV 計算ページを開く**
   - https://9db.jp/pokemongo/data/6606 をブラウザで開いておきます。
4. **iPhone 画面を Windows にミラーする**
   - 次の A または B のどちらかを選んでください。
   - **A) 無線 (AirPlay) でミラー**
     1. Windows に AirPlay 受信アプリ (無料で使う場合は LetsView が扱いやすく、おすすめ。有料でも安定優先なら AirServer 推奨) をインストールします。
     2. iPhone と Windows を同一 Wi-Fi に接続します。
     3. iPhone のコントロールセンター → 画面ミラーリング → Windows 側アプリを選択します。
     4. Windows 上に iPhone のミラーウィンドウが表示されます。
   - **B) 有線 (キャプチャカード) で入力**
     1. Lightning → HDMI アダプタを iPhone に接続します。
     2. HDMI ケーブルで USB キャプチャカードに接続し、PC に差し込みます。
     3. Windows 側でキャプチャデバイスとして認識されているか確認します。

### macOS 環境での事前準備（Windows と一緒に使う想定でも役立ちます）
1. **ブラウザ準備**
   - macOS に最新の Google Chrome または Microsoft Edge（Canary でも可）をインストールし、常に最新化しておきます。
2. **Tampermonkey の導入**
   - Windows と同じく Tampermonkey を追加し有効化します。
3. **iPhone 画面を Mac にミラーする**
   - **A) 無線 (AirPlay)**
     1. macOS のメニューバー右上にあるコントロールセンターから「画面ミラーリング」を開きます。
     2. 同一 Wi-Fi 内にある Mac を選ぶと、Mac 上に iPhone の画面が表示されます（macOS Monterey 以降推奨）。
   - **B) 有線 (QuickTime Player)**
     1. Lightning ケーブルで iPhone を Mac に接続します。
     2. QuickTime Player を起動 → ファイル → 新規ムービー収録。
     3. 録画ボタン横の矢印メニューから「カメラ」「マイク」に iPhone を指定すると、Mac 上でプレビューできます。
   - **C) 有線 (キャプチャカード)**
     1. Lightning → HDMI アダプタ → HDMI ケーブル → USB-C/USB-A キャプチャカードで Mac に入力します。
     2. Chrome の `getUserMedia` からキャプチャデバイス名（例: Cam Link, HDMI Capture）を選択できます。
4. **Windows 側ブラウザから Mac の映像を取得する**（オプション）
   - AirPlay で Mac に映した画面を、さらに Windows 側へ画面共有する場合は、Microsoft Teams / Zoom / OBS の NDI などを経由し、Windows で受信する構成も取れます。

## 3. ユーザースクリプトの導入
1. `docs/iv-ocr-tool.md` と同じリポジトリ内にある `tampermonkey/iv-ocr.user.js` を開き、全コードをコピーしてください。
2. ブラウザ上で Tampermonkey のダッシュボードを開きます。
3. 「新規スクリプトを追加」を選び、エディタにコードを貼り付けて保存します。
4. 9db の IV 計算ページを再読み込みすると、右下に「IV OCR」パネルが表示されます。

## 4. 使い方（初回セットアップ）
1. 9db ページの右下パネルで入力ソース (Screen/Camera) を選び、「開始」を押します。
2. ブラウザの共有ダイアログが表示されるので、目的のミラーウィンドウまたはキャプチャデバイスを選択し、共有を許可してください。
3. プレビューに iPhone の画面が表示されたら、校正ボタン (CP/HP/すな) をそれぞれ押し、プレビュー上で左上→右下の順に 2 回クリックして読み取り枠 (ROI) を作成します。
4. 「保存」で枠の位置情報を `localStorage` に保存します。以後は自動読み込みされます。
5. 「自動入力」を ON にすると、安定して読み取れた数値が自動的に入力欄へ転記されます。
  - パネルが画面外に隠れる場合は、ヘッダー部分をドラッグして移動・位置を調整できます（位置は自動保存されます）。
  - LonelyScreen など横幅が広いミラーアプリを表示する際は、ヘッダー右側の「拡大表示」ボタンでパネル幅を広げられます（再読み込み後も状態は保持されます）。
  - ポケモン名・こうげき/ぼうぎょ/HPバーも自動入力させたい場合は、それぞれの「校正」ボタンで枠を追加してください。バーは横向きゲージ全体を囲むように指定すると精度が安定します。

## 5. 実装ポイント（TypeScript 視点で理解を深める）
- スクリプトはプレーンな JavaScript ですが、`ROI` 型などは JSDoc で疑似的に型定義しており、TypeScript へ移植しやすい構造になっています。
- React や Next.js で同等の UI を作る場合は、以下のベストプラクティスを意識してください。
  - カスタムフックで `getDisplayMedia` / `getUserMedia` を扱い、副作用を `useEffect` で管理する。
  - OCR の重い処理は Web Worker に切り出すか、`useMemo` と `requestAnimationFrame` を組み合わせて負荷を平準化する。
  - ROI や設定値は `localStorage` や `IndexedDB` に保存し、初期化時に読み込む。
  - 状態管理は `useReducer` または Zustand などを使い、描画とロジックを分離する。
- DOM への入力処理は、フォーム属性 (label の `for`、input の `name`/`id`/`placeholder`) を複合的に検索することで、UI 変更に強い実装になっています。
- ポケモン名は `jpn+eng` モードで OCR し、入力欄 (`input[type="search"][placeholder="ポケモンを選択"]`) に反映します。こうげき/ぼうぎょ/HP はゲージ画像の塗りつぶし率を測定し、0～15 の整数に丸めて 9db の IV バー (`atk/def/hp`) へ反映しています。

## 6. よくあるエラーと対処法
| 症状 | 原因の例 | 対処方法 |
| ---- | -------- | -------- |
| 共有するウィンドウ/デバイスが選べない | ブラウザが古い、HTTPS でないページで `getDisplayMedia` を呼んでいる | ブラウザを最新版へ更新。9db は HTTPS なので問題ありませんが、企業ネットワークではブロックされることがあります。 |
| OCR の結果が遅い・認識しない | Tesseract.js の初期読込中、映像が暗い/小さい | 初回は数秒待つ。画面を明るくし、数値部分が大きくなるようズームする。枠がずれている場合は再校正。 |
| 自動入力されない | 9db 側 DOM の構造が変わった、または枠の保存が空 | ラベル探索ロジックにキーワードを追加する。枠が保存されているか `localStorage` を確認。 |
| ブラウザに「アクセスが拒否されました」と表示される | 画面/カメラ許可を拒否した | ページをリロードし、ブラウザの権限ダイアログで許可する。 |

## 7. 次のステップ
- 読み取りの精度を上げたい場合は、以下を検討してください。
  1. OCR 前に二値化・コントラスト調整などの画像前処理を追加する。
  2. ROI ごとに個別のしきい値や拡大率を設定できるようにする。
  3. 認識結果を複数フレームでバッファし、中央値フィルタで安定化する（本スクリプトでは既に 3 フレーム中央値を実装済み）。
- React/Next.js で GUI を組み直す場合は、Vite + React でモックを作り、WebRTC/MediaStream 周りをコンポーネント化すると、保守しやすくなります。

## 8. 要約（高校生でも分かる説明）
- iPhone のポケモン GO 画面をパソコンに映し、その映像から「CP」「HP」「ほしのすな」の数字だけを読み取ります。
- 読み取った数字やゲージから推定した IV を、9db という計算サイトの入力欄・IV バーに自動で入れます。ポケモン名も OCR で入力されます。
- 最初に「数字が画面のどこにあるか」を枠で囲んで覚えさせれば、あとはスワイプするだけで次々に入力されます。
- OCR (オーシーアール) は画像から文字を読み取る技術のことです。今回のスクリプトは Tesseract.js というライブラリを使っています。
